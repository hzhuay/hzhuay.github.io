---
title: 区块链学习笔记
date: 2022-02-26 10:11:55
tags: 区块链, 比特币, 以太坊
categories: 笔记

---

为了开展我的个人项目，第一周的任务是学习区块链的背景知识，了解zkSync的basic idea。

# 区块链

区块链是站在巨人的肩膀上的：

- 1982年，David Chaum提出了注重隐私安全的密码学网络支付系统
- 1985年，Neal Koblitz和Victor Miller各自独立提出著名的椭圆曲线加密算法
- 1991年，Stuart Haber和W. Scott Stornetta提出用时间戳确保数位文件安全的协议
- 1997年，Adam Back发明了Hashcash（哈希现金），采用工作量证明演算法（PoW）
- 1998年，Wei Dai发表了匿名的分散式电子现金系统B-money
- 2001年，NSA发布SHA-2系列算法，其中包括比特币最终采用的SHA-256哈希算法

至此，区块链技术依赖的所有技术基础都具备了

## 加密算法

### 非对称加密算法

- RSA：基于大整数分解
- ECC：基于椭圆曲线

区块链中常用算法是ECC，因为它更难破解。破解228比特的RSA密钥需要的能量可以煮沸一茶匙的水，而破解228比特的ECC密钥需要的能量能煮沸地球上所有的水。

### 哈希函数

应用于梅克尔树、区块指针、挖矿

主要的哈希函数有：

- MD4/MD5（已被攻破）
- SHA家族：SHA-1（已被攻破）、SHA-256（比特币）、SHA-384、SHA-512

在比特币的系统中，除了公钥和私钥外，由于公钥本身还是太复杂了，因此会对公钥使用哈希函数，生成一个**比特币地址**，通过这个地址来进行交易。

![b8Y1Fx.jpg](https://s4.ax1x.com/2022/03/02/b8Y1Fx.jpg)

## 共识机制

拜占庭将军问题：一组拜占庭将军分贝率军围困一座易守难攻的城池。他们的行动只有进攻或撤退，并且他们必须行动一致，否则会损失惨重。他们会通过信使来互相联系，将自己的信息告知给其他将军。每个将军通过自己收到的信息来决定进攻还是撤退。

在是个分布式系统里的模型，可以用来归纳共识机制面临的问题：

- 信使送信太慢：延时
- 信使被中途截杀：信息丢失
- 将军阵亡：服务器宕机
- 叛变、发送假消息、伪造他人信件：攻击者
- 策反：贿赂其他节点，发动合谋攻击

### 安全模型

 根据这个模型，可以按照**安全等级**分出三种安全模型：

- **非拜占庭容错模型**：没有攻击者，所有节点都安全可靠

  错误类型：消息丢失、重复、延时；服务器宕机、通信协议不可靠

- **拜占庭容错模型**：存在攻击者，节点之间互不可信

  错误类型：非拜占庭容错；攻击者篡改消息内容

- **经济模型**：存在有经济实力的攻击者

  攻击类型：大量购买硬件资源试图攻击；贿赂其他节点发动合谋攻击

### 解决方案

根据FLP定理和CAP定理，在一个异步的分布式系统中无法达成强一致性。那么有哪些解决方案呢？

- 非拜占庭容错：适用于分布式数据库
  - 共识机制：Paxos、Raft等
  - 性能较高，容错性较差
- 拜占庭容错：适用于分布式账本（区块链）
  - 共识机制：PoW、PoS、DPos、PBFT
  - 容错性较高，性能较差
  - 设计思路：
    - 提高作恶的成本，降低错误出现的概率
    - 在允许一定恶意节点存在的前提下，依旧实现账本一致

#### 实用拜占庭容错算法

PBFT是目前解决拜占庭容错问题最高的方法，将原有的指数级降到多项式级。

可以容忍少于1/3的节点作恶，而且参与的节点越多，作恶难度越大，性能越差。

适用于有强一致性要求的联盟链、私有链，或者节点数量固定的公有链，如DPOS公链。以为算法要求每次产生新区块，其他所有的区块必须在规定时间内给出反馈，如果超过2/3节点都认可，那么就达成强一致，这个区块就再也无法改动了。

### 比特币类共识机制的特点

- **随机性**

  记账者们解决数学谜题，竞争记账权的过程，可以看做随机选择的过程。由于比特币的一笔交易一般需要6个区块才能最终确认，而作恶者被随机选中6次的概率是很低的。

  但是，随机性想要生效，前提是选择是真随机，或者至少不能被预测或者操控。如果作恶者能掌握大部分的节点或者算力，那么还是可以作恶。

- **抗女巫攻击**：如何抵御通过刷小号方式来提高被选中概率的作恶手法。

  大致思路为提高创建账号或者加入共识需要的成本。挖矿就是一种工作量的门槛，光有小号没有算力是无法作恶的。或者就是对资源设置门槛，也就是使用权益证明。

- **激励机制**

  奖励诚实的参与者，惩罚作恶者的反激励机制。

#### 工作量证明（PoW）

挖矿的谜题就像个模仿，解密很苦难，但是结果是否正确很容易检验。

至于难度目标到底是多少，则是由比特币的程序每隔2016个区块就自动调节一次的，根据之前出块速度和之前难度目标反推全网算力，再根据全网算力设置一个合适的难度目标，让全网平均**10分钟**能出一个块。这样一来，**谁的计算能力强，谁在单位时间内计算次数多，谁就有更大的概率试出符合要求的哈希值，获得记账权和比特币奖励，这种共识机制也被称为工作量证明(PoW)**。

#### 权益证明（POS）

- PoW：拥有算力越大，出块概率越大

- PoS：锁定的代币越多，出块概率越大

抗女巫攻击：通过资源门槛来，因为创建再多的小号，作恶者拥有的代币总量是不变的。

随机性：通过VDF、VRF等函数生成随机数。

激励机制：挖出区块的奖励；手续费

以太坊目前还在采用PoW，但是在2.0版本会采用PoS。

#### 授权权益证明（DPOS）

- PoS：用代币给区块投票

- DPoS：用代币给节点投票

持币者通过锁定代币获得一定投票权，投票给节点候选人，得票排名靠的节点代为行使出块权利，轮流出块。

优势：

- 让专业的人来做专业的事，网络增加安全稳定，并且不是所有的个人用户都愿意承担记账的义务
- 控制记账者的数量，大大降低了达成共识需要的节点数，可以极大提高性能，加快达成共识的速度（每笔交易确认的速度）

劣势：去中心化程度低

# 比特币

Bit Coin，代号（BTC），于2008年以论文形式发布，2009年创世区块诞生。

定位是一种**点对点的电子现金系统**，可以消除目前线上交易对**可信第三方**的依赖。

## 基本规则：

- 每10分钟左右会产生一个新的区块，**一定数量**的比特币会奖励给创建者。
- 奖励数量**每4年减半1次**，最初创建一区块奖励50btc。产生到21万个区块后降为25btc，后面一次对半递减。
- 比特币的上限约为**2100万**个，预计**2140**年左右全部挖出。目前已经挖出近**1800万**个。

### 区块链和比特币之间的关系

区块链是支持比特币作为一款应用的底层技术，提供了**分布式账本技术**，解决了交易各方的**信任问题**。

## 如何运行

假设有交易双方发生了交易，他们会将这比交易的信息全网广播，使分布式账本的状态发生改变。

记账者负责记录一段时间内的**交易信息**，一起参与交易的双方**账户状态**，并打包到一个区块中。由于大约每10分钟产生一个新区块，所以可以看做每一个区块就是**一页账单**，记录了这10分钟内发生的交易。区块按照**时间顺序**串联，上一个区块的结尾时的状态紧接着下一个区块开头的状态，就形成了**区块链**。

### 账户体系

比特币采用**非对称加密**，公钥作为**账号**，私钥作为**密码**。

随机生成私钥，通过数学加密曲线（如椭圆加密曲线）生成公钥。知道公钥**难以**计算出私钥。

### 交易发出

假设A要给B转账，那么A需要：

- 一个交易单，内容包括：付款人A，收款人B，比特币数量，来源（A的余额）。
- A对交易单进行**数字签名**
- B用A的公钥验证数字签名。

### 挖矿：争夺记账权

网络中有很多记账者，他们在自己的账单里记录了上一页账单的哈希值（以此证明账单的连续性），监听别人广播的交易信息并记录在自己的账单中。

那么问题来了，那么多记账者，每个人都有自己版本的账单，到底谁的账单会被公认为下一页账单呢？比特币解决这个问题的方式是**数学谜题**。

`H ( nonce || prev_hash || tx || tx ... || tx ) < target` 

（随机值+上个区块的哈希值+记录的交易）取哈希值，结果要满足一个很难达到的条件。记账者需要不断尝试随机数，第一个尝试成功的人拥有记账权。

### 记账验证

记账者获得记账权后，发布的区块需要被全网检验后才能接收，成为被公认的下一页账单。

其他记账者会检查：

- 验证上一个区块的哈希值，和自己记录的是否一样。
- 验证每一笔交易是否合法：付款人和收款人的签名，交易余额是否足够
- 验证本页的哈希值是否有效

通过验证后，获胜者可以获得奖励：

- 区块奖励：挖出一个区块会奖励一定数量的比特币
- 交易手续费：这一个区块中记录的所有交易，都能从中获得一笔手续费。

### 交易模型：UTXO模型

UTXO: Unspent Transaction Output 未花费的交易输出

重点在于记录**交易**而非**余额**：

- 传统账户交易：只看余额在交易前后的状态，加减账户的余额数字。
- 基于UTXO的交易：只记录交易过程，下一笔交易的输入必须是之前交易的输出

比如A要给B转账20btc，账本中记录的不是A的余额减少了20，B增加了20。而是50个btc从A点流出，其中20流入了B，30流入了A。

用上一笔的流入作为下一笔的流出，并且可能是多笔流入一起作为下一笔流出。

#### 双花问题

电子货币容易出现**双花问题**。A可以同时声称自己将一比钱转给了B和C。比特币使用**分叉与最长链原则**来解决。

A如果要双花，那么他会将这两笔交易都广播。由于网络状况，不同的记账者接收到这两笔交易的先后顺序不同，并且收到一种一条后就不会再记录另一条。假设有两个记账者分别记录的给B和C的交易，并且几乎同时完成了数学谜题，那么他们会各自产生新区块，并且都认为自己是应该被公认的，这样就产生了**分叉**。

不同的分叉产生了不同的账本，只有记账者认可数最多的版本，才是公认的账本。如何体现认可数呢？通过区块链的**长度**。记账者会在他们认可的账本后面继续记账，因此越多人认可的区块链，有越多人参与，经过一段时间后该链的长度就会明显长与其他分叉，成为公认的账本。在比特币中，大家一般等待**6个区块**来确认一笔交易。注意，这只是一个**约定俗成**的数字。



# 以太坊

Ethereum，数字货币代号**ETH**，是区块链2.0应用的代表。相比1.0：

| 区块链1.0（以比特币为代表）      | 区块链2.0（以太坊为代表）      |
| :------------------------------- | ------------------------------ |
| 非图灵完备：只能执行有限类型指定 | 图灵完备的                     |
| 不支持智能合约                   | 支持智能合约                   |
| 定位于支付网络，数字货币         | 定位于平台，可以衍生出各种应用 |

图灵完备：指机器执行任何其他可编程计算机能够执行计算的能力。一切可计算的问题都能解决，这样的虚拟机或者编程语言就叫图灵完备。

比特币的系统是图灵不完备的，而以太坊的智能合约系统是图灵完备的，实现了**可编程的区块链**，可以创建自己的应用，因此才说定位于**平台**。

## 智能合约

传统的非智能合约，需要一个第三方来确保合约执行。

智能合约就是写在区块链上的一串自动执行的代码，一方面它不断地监听预置触发条件是否达到，如果达到了则执行预置的行动。

### DApp

以智能合约作为后台，加上数据库和前段界面后，就形成了DApp（去中心化的APP）。与传统APP最大的区别在于去中心化，说明其后端和数据库不是在某个中心化服务器，而是放在区块链上的。

## 发币和ICO

为什么市面上有那么多数字货币？

因为他们很多是基于以太坊上的**ERC20协议**发行的代币。该协议允许用户自定义并发行Token，该Token的交易会被监听并记录在以太坊区块链上，因此其安全性和可信度等同于以太币ETH。该种代币发行方式有开源的代码模板可以借鉴，因此技术门槛比较低，吸引了各种人来发币。

其实很多代币的发行是一种**众筹模式**。比如一个团队打算开发一款DApp，他们可以先发币，声称该货币会在他们DApp中有作用，但是目前还在开发阶段。别人可以先买币，项目团队用买币的收入来开发，等开发完成后，这种货币也会有价值了，那么前期买币的人就获得了收益。这种就是Initial Coin Offering（**首次发行代币**）。

代币在区块链上火交易所内迅速流通，流动性媲美上市。但是其极强的流动性和该时期监管的缺失造成了极强的炒作性。大量散户涌入也加剧了盲目投机，催生出了一批借发币形式来圈钱的假项目，使发出的代币沦为“空气币”。

## 以太币ETH的作用

- 以太坊上用于支付交易手续费和运算服务的介质

  - 交易手续费：同比特币等电子现金系统，是给记账者的奖励

  - 运算服务费：支付费用来运算智能合约或者其他以太坊上的程序（因为在以太坊上，节点不仅要负责记账，还需要负责智能合约的运算）

- ICO众筹中最常用的募资款项

- 加密货币交易市场中的主流交易对（不同代币之间的价值媒介）

## 应用

目前有2个比较有前景的应用方向

### 1. 去中心化金融DeFi

消除传统金融中的中介方、繁琐的手续和交易成本。

支付：不再依赖银行的账户系统，而是点对点支付，在跨国支付场景下尤为轻便
借贷：抵押资产借钱，在传统金融中只能抵押给银行等放贷机构，而智能合约的信用使得普惠借贷成为可能。
交易：去中心化交易所，链上撮合交易，无中心化风险（删库跑路）

### 2. 去中心化自治组织DAO

公司一般会有自己的章程，但是现实执行中未必会遵守。而DAO可以实现编程化的组织管理，即规则公开透明且无法篡改，满足条件自动执行，由程序替代人为管理。 

这样的特性也可以支持分布式协作。我们可以不需要认识组织内的成员，只需要认可规则，就可以一起协作。

## 以太坊2.0

- 共识机制切换：从PoW更换为POS
- 性能提升：采用分片技术，实现性能横向扩展

- 两条链：将于以太坊1.0并行存在，后期可能合并



# zkSync

> This video [L2 scalability and zkSync (Edcon talk) ]([L2 scalability and zkSync (Edcon talk) - YouTube](https://www.youtube.com/watch?v=el-9YYGN1nw&t=97s))is from the website of zkSync

This video talks about scalability problem. In the speaker's opinion, it is hard to scale blockchain because the core value propositon of layer 1 is resilience. The way that BitCoin and Etherum reach resilience is decentralization. 

However, in order to ensure security in such an open system, every transactioin executed every L1 node should be verified, rather than easily trusted. Including more nodes in the system requires more verification, and this could be bad for scalability. Only increasing throughput will rise the requirement of nodes, which leads to less qualified nodes. Therefore, the scalability means increasing throughput without increasing node load.

There are two way to do this:

- Sharding: not verify every transaction, but only a few of them.
- Compression: verify a larger amount of transcations by spending the same amount of computational resources. 

Most of technologies, no matter they belong to Sharding or Compression, have **data availbility problem**. Most of them keep data off-chain, which makes it possible to withhold the data. **Optimisitc rollup** and **zkRollup** keep data on-chain. With rollup technology, the levels of security and usability are very close to mainnet, but the cost is that scalability boost is capped at 100x compared to mainnet. 

key words:

- zero-knowledge proofs
- on-chain data availability

Problems zkSync solves:

- Reduce the gas fees on Ethereum
- Provide a banking alternative
- DeFi with Paypal-scale

Features:

- Mainnet-level security with zero reliance on 3rd parties
- ETH and ERC20 token transfers with instant confirmations and 10-minute finality on L1*; see [supported tokens](https://docs.zksync.io/userdocs/tokens.html#supported-tokens)
- Ultra-low transaction fees (~1/100th of mainnet costs for ERC20 tokens and ~1/30th for ETH transfers)
