---
title: csapp
date: 2022-10-24 09:48:05
categories: OS
tags: 
---

一个C程序从源代码`main.c`到可执行文件需要经历以下步骤

1. 预编译：由C preprocesser编译得到`main.i`文件
2. 编译：由cc1编译得到汇编程序`main.s`
3. 汇编：由assembler编译为`mian.o`可重定向文件
4. 链接：将`main.o`中引用的其他程序和必要的系统文件链接在一起，得到可执行文件`main.out`。

链接器的主要任务：

- 简单解析（符号解析）：获取代码中的符号，一般是变量和函数。
- 重定位：在合并不同的源码时，将不同文件中的符号的相对地址转换为内存中的物理地址。

共享目标文件`.so`，可重定位目标文件`.o`，可执行目标文件`.out`，都遵循Executable and Linkable Format (ELF) 格式。从上至下定义了以下数据：

- ELF header：word大小，byte ordering，文件类型，机器类型等
- Segment header table：页大小，虚拟地址段，段大小
- .text区：源代码
- .rodata区：只读数据，比如跳表等
- .data区：初始化过的全局变量。包括局部静态变量
- .bss区：未初始化的全局变量，由于未初始化所以只用记录符号，不占用内存
- .symtab区：符号表
- .rel .text：记录代码区需要重定位的指令
- .rel .data：记录.data区中需要重定位的数据
- .debug区：用`-g`编译时生成debug信息
- section header table：以上所有section的起始位置

三种链接器符号：

- 全局符号：在一个模块中定义，并且可以被其他模块使用。比如非静态的函数和全局变量。
- 外部符号：在某模块中被引用，但是定义在其他模块的符号。
- 局部符号：定义和使用都在模块内部的符号。比如静态的全局变量和函数。所以**局部符号不等于局部变量**。

强符号：有初始化的全部变量或者函数。

链接器不允许有同名的强符号。如果同时存在强符号和弱符号，链接器总选择强符号。如果只存在多个弱符号，链接器会随机选择一个。
